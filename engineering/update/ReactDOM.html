<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ReactDOM.render | xal&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.1">
    
    <meta name="description" content="不积硅步无以至千里">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.db583d94.js" as="script"><link rel="preload" href="/assets/js/2.13f24521.js" as="script"><link rel="preload" href="/assets/js/44.3daad448.js" as="script"><link rel="prefetch" href="/assets/js/10.20f1c349.js"><link rel="prefetch" href="/assets/js/11.e9a3a4d7.js"><link rel="prefetch" href="/assets/js/12.800ac1de.js"><link rel="prefetch" href="/assets/js/13.eeb3a0d5.js"><link rel="prefetch" href="/assets/js/14.d0306435.js"><link rel="prefetch" href="/assets/js/15.dd16db64.js"><link rel="prefetch" href="/assets/js/16.960607bf.js"><link rel="prefetch" href="/assets/js/17.a9bc1e47.js"><link rel="prefetch" href="/assets/js/18.59dba844.js"><link rel="prefetch" href="/assets/js/19.1ad3d500.js"><link rel="prefetch" href="/assets/js/20.b4ad3d9f.js"><link rel="prefetch" href="/assets/js/21.4ca61081.js"><link rel="prefetch" href="/assets/js/22.ce333414.js"><link rel="prefetch" href="/assets/js/23.76f26f55.js"><link rel="prefetch" href="/assets/js/24.cb939bef.js"><link rel="prefetch" href="/assets/js/25.0f9bf0a2.js"><link rel="prefetch" href="/assets/js/26.eef836fe.js"><link rel="prefetch" href="/assets/js/27.62af0bc1.js"><link rel="prefetch" href="/assets/js/28.2736074d.js"><link rel="prefetch" href="/assets/js/29.0f594431.js"><link rel="prefetch" href="/assets/js/3.f72fd6e6.js"><link rel="prefetch" href="/assets/js/30.87b6f964.js"><link rel="prefetch" href="/assets/js/31.4a2a7d81.js"><link rel="prefetch" href="/assets/js/32.007f9cb2.js"><link rel="prefetch" href="/assets/js/33.35f87b20.js"><link rel="prefetch" href="/assets/js/34.bfad2641.js"><link rel="prefetch" href="/assets/js/35.f3f9fd70.js"><link rel="prefetch" href="/assets/js/36.db51391d.js"><link rel="prefetch" href="/assets/js/37.4ce99ebd.js"><link rel="prefetch" href="/assets/js/38.ad423e48.js"><link rel="prefetch" href="/assets/js/39.f9c98285.js"><link rel="prefetch" href="/assets/js/4.76b7f9ea.js"><link rel="prefetch" href="/assets/js/40.a1f23fb3.js"><link rel="prefetch" href="/assets/js/41.de28988e.js"><link rel="prefetch" href="/assets/js/42.46c2ad3d.js"><link rel="prefetch" href="/assets/js/43.3fc4e391.js"><link rel="prefetch" href="/assets/js/45.cd4a9560.js"><link rel="prefetch" href="/assets/js/46.fd8a5806.js"><link rel="prefetch" href="/assets/js/47.6285f855.js"><link rel="prefetch" href="/assets/js/48.d8e67c73.js"><link rel="prefetch" href="/assets/js/49.043270fd.js"><link rel="prefetch" href="/assets/js/5.86ead953.js"><link rel="prefetch" href="/assets/js/50.2a92ea97.js"><link rel="prefetch" href="/assets/js/51.5dd5aeac.js"><link rel="prefetch" href="/assets/js/52.7761ae31.js"><link rel="prefetch" href="/assets/js/53.5e0482a2.js"><link rel="prefetch" href="/assets/js/54.b440e01b.js"><link rel="prefetch" href="/assets/js/55.6d23d511.js"><link rel="prefetch" href="/assets/js/56.1cecfbce.js"><link rel="prefetch" href="/assets/js/57.ea590f0c.js"><link rel="prefetch" href="/assets/js/58.3243c66e.js"><link rel="prefetch" href="/assets/js/59.0f685c61.js"><link rel="prefetch" href="/assets/js/6.edb20b01.js"><link rel="prefetch" href="/assets/js/60.2e107991.js"><link rel="prefetch" href="/assets/js/61.93df4bd3.js"><link rel="prefetch" href="/assets/js/62.72c8a1e4.js"><link rel="prefetch" href="/assets/js/63.61d90723.js"><link rel="prefetch" href="/assets/js/64.ab8607c9.js"><link rel="prefetch" href="/assets/js/65.0411cf08.js"><link rel="prefetch" href="/assets/js/66.e085990a.js"><link rel="prefetch" href="/assets/js/67.04c772cb.js"><link rel="prefetch" href="/assets/js/7.0bf49390.js"><link rel="prefetch" href="/assets/js/8.ddb2f3fe.js"><link rel="prefetch" href="/assets/js/9.8139f065.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">xal's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link router-link-active">
  React源码解析
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/" class="nav-link">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link router-link-active">
  React源码解析
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>创建更新</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/engineering/update/ReactDOM.html" aria-current="page" class="active sidebar-link">ReactDOM.render</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#reactdom" class="sidebar-link">ReactDOM</a></li><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#render" class="sidebar-link">render</a></li><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#createcontainer" class="sidebar-link">createContainer</a></li><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#unbatchedupdates" class="sidebar-link">unbatchedUpdates</a></li><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#updatecontainer" class="sidebar-link">updateContainer</a></li><li class="sidebar-sub-header"><a href="/engineering/update/ReactDOM.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/engineering/update/updateQueue.html" class="sidebar-link">updateQueue</a></li><li><a href="/engineering/update/Fiber.html" class="sidebar-link">Fiber 数据结构</a></li><li><a href="/engineering/update/expirationTime.html" class="sidebar-link">expirationTime计算</a></li><li><a href="/engineering/update/模拟UpdateQueue.html" class="sidebar-link">模拟 UpdateQueue</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>任务调度</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>功能</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Hooks</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="reactdom-render"><a href="#reactdom-render" class="header-anchor">#</a> ReactDOM.render</h1> <p>React 创建更新的三种方式</p> <ul><li>ReactDOM.render || hydrate</li> <li>setState</li> <li>forceUpdate</li></ul> <p>我们在编写 React 程序时,都会类似一下代码</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这是React渲染的入口方法</p> <h2 id="reactdom"><a href="#reactdom" class="header-anchor">#</a> ReactDOM</h2> <p>ReactDOM 定义在文件 packages/react-dom/src/client/ReactDOM.js中。<br>
在 react-dom/client/ReactDOM.js 可以看到导出了 render 等方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
    findDOMNode<span class="token punctuation">,</span>
    render<span class="token punctuation">,</span>
    hydrate<span class="token punctuation">,</span>
    unstable_renderSubtreeIntoContainer<span class="token punctuation">,</span>
    unmountComponentAtNode<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./ReactDOMLegacy'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>我们在 ReactDOMLegacy.js 找到 render 方法如下:</p> <h2 id="render"><a href="#render" class="header-anchor">#</a> render</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
    <span class="token parameter">element<span class="token operator">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invariant</span><span class="token punctuation">(</span>
        <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        element<span class="token punctuation">,</span>
        container<span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token punctuation">,</span>
        callback<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以看到返回了一个 legacyRenderSubtreeIntoContainer执行的结果,现在我们再去看看这个方法</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
    <span class="token parameter">parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
    container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    forceHydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// TODO: Without `any` type, Flow says &quot;Property cannot be accessed on any</span>
    <span class="token comment">// member of intersection type.&quot; Whyyyyyy.</span>
    <span class="token keyword">let</span> root<span class="token operator">:</span> RootType <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Initial mount</span>
        root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
            container<span class="token punctuation">,</span>
            forceHydrate<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
        <span class="token comment">// 封装了callBack函数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
            <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Initial mount should not be batched.</span>
        <span class="token comment">// 初始化不走批处理逻辑,为了快</span>
        <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
            <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Update</span>
        <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>由render方法传进来的参数如下:</p> <table><thead><tr><th>参数名</th> <th style="text-align:center;">参数值</th> <th>含义</th></tr></thead> <tbody><tr><td>parentComponent</td> <td style="text-align:center;">null</td> <td>父组件</td></tr> <tr><td>children</td> <td style="text-align:center;">element</td> <td>待渲染的元素即我们传如的</td></tr> <tr><td>container</td> <td style="text-align:center;">container</td> <td>渲染元素的容器</td></tr> <tr><td>forceHydrate</td> <td style="text-align:center;">false</td> <td>是否服务的渲染</td></tr></tbody></table> <ol><li><p>第一次进入 root 为undefined 创建 ReactRoot,调用了legacyCreateRootFromDOMContainer 方法,并 赋值给了 root 和 container._reactRootContainer</p></li> <li><p>取出 root._internalRoot 并赋值给 fiberRoot,</p></li> <li><p>如果有 callback 对他进行一次封装</p></li> <li><p>初始化执行 unbatchedUpdates 并执行 updateContainer</p></li> <li><p>非初始化直接执行 updateContainer,并传入上面赋值的 fiberRoot 等参数</p></li> <li><p>返回 getPublicRootInstance 调用的结果</p></li></ol> <p>OK,我们现在来看看 legacyCreateRootFromDOMContainer 干了什么</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
    <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    forceHydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootType <span class="token punctuation">{</span>
    <span class="token keyword">const</span> shouldHydrate <span class="token operator">=</span>
    forceHydrate <span class="token operator">||</span> <span class="token function">shouldHydrateDueToLegacyHeuristic</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// First clear any existing content.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shouldHydrate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> warned <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> rootSibling<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rootSibling <span class="token operator">=</span> container<span class="token punctuation">.</span>lastChild<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            container<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>rootSibling<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
    container<span class="token punctuation">,</span>
    shouldHydrate
        <span class="token operator">?</span> <span class="token punctuation">{</span>
            hydrate<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><ol><li>判断是不是服务端渲染,很明显这是是false</li> <li>执行一个循环 移除 container 的子元素</li> <li>返回 createLegacyRoot 执行的结果</li></ol> <p>我们在 ReactDOMRoot.js 中看看 createLegacyRoot 干了啥</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createLegacyRoot</span><span class="token punctuation">(</span>
    <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    options<span class="token operator">?</span><span class="token operator">:</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> RootType <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> LegacyRoot<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>看来也没干啥,直接返回 ReactDOMBlockingRoot 类的实例对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ReactDOMBlockingRoot</span><span class="token punctuation">(</span>
    <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>同时我们发现 ReactDOMRoot 和 ReactDOMBlockingRoot 类似</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">ReactDOMRoot</span><span class="token punctuation">(</span><span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span> options<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> RootOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot <span class="token operator">=</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> ConcurrentRoot<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>并且他们挂载原型的方法也是一样的</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
  <span class="token parameter">children<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
  <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token class-name">ReactDOMRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>unmount <span class="token operator">=</span> <span class="token class-name">ReactDOMBlockingRoot</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token keyword">const</span> container <span class="token operator">=</span> root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
    <span class="token function">updateContainer</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">unmarkContainerAsRoot</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>为啥一样现在我们先不讨论,去看 <strong>createRootImpl</strong> 的实现</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">createRootImpl</span><span class="token punctuation">(</span>
    <span class="token parameter">container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">|</span> RootOptions<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Tag is either LegacyRoot or Concurrent Root</span>
    <span class="token keyword">const</span> hydrate <span class="token operator">=</span> options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>hydrate <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hydrationCallbacks <span class="token operator">=</span>
    <span class="token punctuation">(</span>options <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>hydrationOptions<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">markContainerAsRoot</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">,</span> container<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hydrate <span class="token operator">&amp;&amp;</span> tag <span class="token operator">!==</span> LegacyRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> doc <span class="token operator">=</span>
            container<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span>
            <span class="token operator">?</span> container
            <span class="token operator">:</span> container<span class="token punctuation">.</span>ownerDocument<span class="token punctuation">;</span>
        <span class="token function">eagerlyTrapReplayableEvents</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>此方法最重要的功能就是调用 createContainer 创建root并返回。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createContainer<span class="token punctuation">,</span> updateContainer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react-reconciler/inline.dom'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们去 react-reconciler/src/ReactFiberReconciler.js 找到 createContainer 方法</p> <h2 id="createcontainer"><a href="#createcontainer" class="header-anchor">#</a> createContainer</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>
    <span class="token parameter">containerInfo<span class="token operator">:</span> Container<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
    hydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    hydrationCallbacks<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> OpaqueRoot <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">,</span> hydrationCallbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createFiberRoot</span><span class="token punctuation">(</span>
    <span class="token parameter">containerInfo<span class="token operator">:</span> any<span class="token punctuation">,</span>
    tag<span class="token operator">:</span> RootTag<span class="token punctuation">,</span>
    hydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
    hydrationCallbacks<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseHydrationCallbacks<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> FiberRoot <span class="token punctuation">{</span>
    <span class="token keyword">const</span> root<span class="token operator">:</span> FiberRoot <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FiberRootNode</span><span class="token punctuation">(</span>containerInfo<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> hydrate<span class="token punctuation">)</span><span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSuspenseCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        root<span class="token punctuation">.</span>hydrationCallbacks <span class="token operator">=</span> hydrationCallbacks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建第一个FiberNode</span>
    <span class="token keyword">const</span> uninitializedFiber <span class="token operator">=</span> <span class="token function">createHostRootFiber</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    root<span class="token punctuation">.</span>current <span class="token operator">=</span> uninitializedFiber<span class="token punctuation">;</span>
    uninitializedFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> root<span class="token punctuation">;</span>

    <span class="token function">initializeUpdateQueue</span><span class="token punctuation">(</span>uninitializedFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> root<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>可以看到 直接返回一个创建的 FiberRoot 对象</p> <p>到此我们上面的创建过程就走完,过程如下</p> <p>创建 ReactRoot 的过程中创建了 FiberRoot,挂载在了 dom 元素 _reactRootContainer 上, 从 new ReactDOMBlockingRoot 的 _internalRoot 取出创建的 FiberRoot 并赋值给了 fiberRoot</p> <h2 id="unbatchedupdates"><a href="#unbatchedupdates" class="header-anchor">#</a> unbatchedUpdates</h2> <p>然后执行 unbatchedUpdates,初始化不走批处理,为了快,也在 react-reconciler/src/ReactFiberReconciler.js 文件</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> unbatchedUpdates<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
    <span class="token comment">// 按位操作</span>
    executionContext <span class="token operator">&amp;=</span> <span class="token operator">~</span>BatchedContext<span class="token punctuation">;</span>
    executionContext <span class="token operator">|=</span> LegacyUnbatchedContext<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Flush the immediate callbacks that were scheduled during this batch</span>
            <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h2> <p>在 unbatchedUpdates 调用 updateContainer,</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
    <span class="token parameter">element<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
    container<span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>
    parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{</span>
    <span class="token comment">// FiberNode </span>
    <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
    <span class="token comment">// 通过 msToExpirationTime 得到currentTime  Date.now()</span>
    <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前批量更新的配置, 是一个全局对象</span>
    <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据给任务分优先级，来得到不同的过期时间</span>
    <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
        currentTime<span class="token punctuation">,</span>
        current<span class="token punctuation">,</span>
        suspenseConfig<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Caution: React DevTools currently depends on this property</span>
    <span class="token comment">// being called &quot;element&quot;.</span>
    update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span>element<span class="token punctuation">}</span><span class="token punctuation">;</span>

    callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// update 添加到 fiber.updateQuene链表</span>
    <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 调度和更新当前current对象(HostRootFiber)</span>
    <span class="token function">scheduleWork</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> expirationTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> expirationTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>updateContainer 做了以下几件事情</p> <ol><li>拿到 FiberNode</li> <li>设置 expirationTime,过期时间,并设置优先级</li> <li>新建一个 uodate 并添加到 enqueueUpdate 里面</li> <li>执行调度 scheduleWork</li></ol> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>创建 ReactRoot</li> <li>创建 ReactRoot 会调用 createContainer 创建 FiberRoot</li> <li>调用 unbatchUpdate 非批处理</li> <li>调用 updateContainer</li> <li>设置 expirationTime 超时时间</li> <li>React.render 或者 setState 会生成一个 update,赋值给Fiber.updateQueue</li> <li>进入 scheduleWork,执行任务调度</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/3/2021, 10:20:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/engineering/basics/requestIdleCallback.html" class="prev">
        requestIdleCallback
      </a></span> <span class="next"><a href="/engineering/update/updateQueue.html">
        updateQueue
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.db583d94.js" defer></script><script src="/assets/js/2.13f24521.js" defer></script><script src="/assets/js/44.3daad448.js" defer></script>
  </body>
</html>
