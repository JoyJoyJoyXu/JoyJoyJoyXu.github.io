<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>babel原理 | xal&#39;s blog</title>
    <meta name="generator" content="VuePress 1.8.1">
    
    <meta name="description" content="不积硅步无以至千里">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.2e2609af.js" as="script"><link rel="preload" href="/assets/js/2.13f24521.js" as="script"><link rel="preload" href="/assets/js/61.808b2edd.js" as="script"><link rel="prefetch" href="/assets/js/10.20f1c349.js"><link rel="prefetch" href="/assets/js/11.44f046cd.js"><link rel="prefetch" href="/assets/js/12.35463d0d.js"><link rel="prefetch" href="/assets/js/13.a34067a0.js"><link rel="prefetch" href="/assets/js/14.5a445c43.js"><link rel="prefetch" href="/assets/js/15.880a6276.js"><link rel="prefetch" href="/assets/js/16.57e668ac.js"><link rel="prefetch" href="/assets/js/17.c38dab49.js"><link rel="prefetch" href="/assets/js/18.6b944b7f.js"><link rel="prefetch" href="/assets/js/19.75b256b6.js"><link rel="prefetch" href="/assets/js/20.b4ad3d9f.js"><link rel="prefetch" href="/assets/js/21.4ca61081.js"><link rel="prefetch" href="/assets/js/22.306b4d79.js"><link rel="prefetch" href="/assets/js/23.76f26f55.js"><link rel="prefetch" href="/assets/js/24.cb939bef.js"><link rel="prefetch" href="/assets/js/25.cc8962df.js"><link rel="prefetch" href="/assets/js/26.475a0881.js"><link rel="prefetch" href="/assets/js/27.b939f73b.js"><link rel="prefetch" href="/assets/js/28.657bae2f.js"><link rel="prefetch" href="/assets/js/29.70e82b3b.js"><link rel="prefetch" href="/assets/js/3.7313031a.js"><link rel="prefetch" href="/assets/js/30.5fc9a97e.js"><link rel="prefetch" href="/assets/js/31.8e7dc58a.js"><link rel="prefetch" href="/assets/js/32.97bcd671.js"><link rel="prefetch" href="/assets/js/33.381f1361.js"><link rel="prefetch" href="/assets/js/34.bfad2641.js"><link rel="prefetch" href="/assets/js/35.555716d0.js"><link rel="prefetch" href="/assets/js/36.bf8c92da.js"><link rel="prefetch" href="/assets/js/37.67542825.js"><link rel="prefetch" href="/assets/js/38.0a319de6.js"><link rel="prefetch" href="/assets/js/39.928a5845.js"><link rel="prefetch" href="/assets/js/4.76b7f9ea.js"><link rel="prefetch" href="/assets/js/40.90b30eb3.js"><link rel="prefetch" href="/assets/js/41.43a1c8f4.js"><link rel="prefetch" href="/assets/js/42.b0368b83.js"><link rel="prefetch" href="/assets/js/43.ff4fd4c7.js"><link rel="prefetch" href="/assets/js/44.25cb5a49.js"><link rel="prefetch" href="/assets/js/45.de082558.js"><link rel="prefetch" href="/assets/js/46.fd8a5806.js"><link rel="prefetch" href="/assets/js/47.596a38f9.js"><link rel="prefetch" href="/assets/js/48.d8e67c73.js"><link rel="prefetch" href="/assets/js/49.4ad6da3f.js"><link rel="prefetch" href="/assets/js/5.86ead953.js"><link rel="prefetch" href="/assets/js/50.25404cad.js"><link rel="prefetch" href="/assets/js/51.d33de486.js"><link rel="prefetch" href="/assets/js/52.1cdcf4b4.js"><link rel="prefetch" href="/assets/js/53.8c08b7f2.js"><link rel="prefetch" href="/assets/js/54.e266232d.js"><link rel="prefetch" href="/assets/js/55.7cd147a2.js"><link rel="prefetch" href="/assets/js/56.ef0ffe31.js"><link rel="prefetch" href="/assets/js/57.f8ae0bd0.js"><link rel="prefetch" href="/assets/js/58.3d2d7a34.js"><link rel="prefetch" href="/assets/js/59.5d60955e.js"><link rel="prefetch" href="/assets/js/6.edb20b01.js"><link rel="prefetch" href="/assets/js/60.1e7845c9.js"><link rel="prefetch" href="/assets/js/62.e85be5fd.js"><link rel="prefetch" href="/assets/js/7.0bf49390.js"><link rel="prefetch" href="/assets/js/8.f55c654f.js"><link rel="prefetch" href="/assets/js/9.8929a0ae.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">xal's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/home/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  React源码解析
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/home/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/algorithm/" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/engineering/" class="nav-link">
  React源码解析
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>TypeScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>小程序原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>杂项</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/home/others/babel.html" aria-current="page" class="active sidebar-link">Babel 原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/home/others/babel.html#babel是什么" class="sidebar-link">Babel是什么？</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#babel的运行原理" class="sidebar-link">Babel的运行原理</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#实践前提" class="sidebar-link">实践前提</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/home/others/babel.html#babel-core" class="sidebar-link">babel-core</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#babel-types" class="sidebar-link">babel-types</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#visitors-访问者" class="sidebar-link">Visitors (访问者)</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#paths-路径" class="sidebar-link">Paths（路径）</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#paths-in-visitors-存在于访问者中的路径" class="sidebar-link">Paths in Visitors（存在于访问者中的路径）</a></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#babel插件规则" class="sidebar-link">Babel插件规则</a></li></ul></li><li class="sidebar-sub-header"><a href="/home/others/babel.html#撸一个babel插件" class="sidebar-link">撸一个Babel插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/home/others/babel.html#文件结构" class="sidebar-link">文件结构</a></li></ul></li></ul></li><li><a href="/home/others/clinux.html" class="sidebar-link">前端常用Linux命令</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="babel原理"><a href="#babel原理" class="header-anchor">#</a> babel原理</h1> <blockquote><p>以下文章来自前端时刻，作者null仔</p></blockquote> <h2 id="babel是什么"><a href="#babel是什么" class="header-anchor">#</a> Babel是什么？</h2> <div class="custom-block tip"><p class="custom-block-title">什么是babel ?</p> <p>Babel 是一个 JavaScript 编译器。他把最新版的javascript编译成当下可以执行的版本，简言之，利用babel就可以让我们在当前的项目中随意的使用这些新最新的es6，甚至es7的语法。</p> <p><strong>为了能用可爱的ES678910写代码,我们必须了解它!</strong></p></div> <h2 id="babel的运行原理"><a href="#babel的运行原理" class="header-anchor">#</a> Babel的运行原理</h2> <p><img src="/img/640.jpg" alt="640.jpg" title="640.jpg"></p> <ol><li>解析</li></ol> <p>解析步骤接收代码并输出 AST。这个步骤分为两个阶段：词法分析（Lexical Analysis） 和 语法分析（Syntactic Analysis）</p> <div class="language- extra-class"><pre><code>1. 词法分析

    词法分析阶段把字符串形式的代码转换为 令牌（tokens） 流。

    你可以把令牌看作是一个扁平的语法片段数组：
    
    比如代码：n*n 转换如下：

    ```js
    [
        {type:{...},value:&quot;n&quot;,start:0,end:1,loc:{...}},
        {type:{...},value:&quot;*&quot;,start:2,end:3,loc:{...}},
        {type:{...},value:&quot;n&quot;,start:4,end:5,loc:{...}},
        ...
    ]
    ```
    每一个 type 有一组属性来描述该令牌：

    ```js
    {
        type:{
            label:'name',
            keyword:undefined,
            beforeExpr:false,
            startsExpr:true,
            rightAssociative:false,
            isLoop:false,
            isAssign:false,
            prefix:false,
            postfix:false,
            binop:null,
            updateContext:null,
        },
        ...
    }
    ```
    和 AST 节点一样它们也有 start，end，loc 属性。

2. 语法分析

语法分析阶段会把一个令牌流转换成 AST 的形式。这个阶段会使用令牌中的信息把它们转换成一个 AST 的表述结构，这样更易于后续的操作。

简单来说，解析阶段就是

**code(字符串形式代码)-&gt;tokens(令牌流)-&gt;AST（抽象语法树）**

Babel 使用 @babel/parser 解析代码，输入的 js 代码字符串根据 ESTree 规范生成 AST（抽象语法树）。Babel 使用的解析器是 babylon。
</code></pre></div><ol start="2"><li>转换</li></ol> <p>转换步骤接收 AST 并对其进行遍历，在此过程中对节点进行添加、更新及移除等操作。这是 Babel 或是其他编译器中最复杂的过程。</p> <p>Babel提供了@babel/traverse(遍历)方法维护这AST树的整体状态，并且可完成对其的替换，删除或者增加节点，这个方法的参数为原始AST和自定义的转换规则，返回结果为转换后的AST。</p> <ol start="3"><li>生成</li></ol> <p>代码生成步骤把最终（经过一系列转换之后）的 AST 转换成字符串形式的代码，同时还会创建源码映射（source maps）。</p> <p>代码生成其实很简单：深度优先遍历整个 AST，然后构建可以表示转换后代码的字符串。</p> <p>Babel使用 @babel/generator 将修改后的 AST 转换成代码，生成过程可以对是否压缩以及是否删除注释等进行配置，并且支持 sourceMap。</p> <p><img src="/img/641.jpg" alt="641.jpg" title="641.jpg"></p> <h2 id="实践前提"><a href="#实践前提" class="header-anchor">#</a> 实践前提</h2> <p>在这之前,你必须对Babel有了基本的了解,下面我们简单的了解下babel的一些东西,以便于后面开发插件。</p> <h3 id="babel-core"><a href="#babel-core" class="header-anchor">#</a> babel-core</h3> <p>babel-core是Babel的核心包,里面存放着诸多核心API,这里说下transform。</p> <p>transform : 用于字符串转码得到AST 。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//安装</span>
npm install  babel<span class="token operator">-</span>core <span class="token operator">-</span><span class="token constant">D</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> babel <span class="token keyword">from</span> <span class="token string">'babel-core'</span><span class="token punctuation">;</span>

<span class="token comment">/*

 * @param {string} code 要转译的代码字符串

 * @param {object} options 可选，配置项

 * @return {object}

*/</span>
babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>code<span class="token operator">:</span>String<span class="token punctuation">,</span>options<span class="token operator">?</span><span class="token operator">:</span>Object<span class="token punctuation">)</span>
<span class="token comment">//返回一个对象(主要包括三个部分)：</span>
<span class="token punctuation">{</span>

    generated code<span class="token punctuation">,</span>  <span class="token comment">//生成码</span>
    sources map<span class="token punctuation">,</span>     <span class="token comment">//源映射</span>
    <span class="token constant">AST</span>             <span class="token comment">//即abstract syntax tree，抽象语法树</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="babel-types"><a href="#babel-types" class="header-anchor">#</a> babel-types</h3> <p>Babel Types模块是一个用于 AST 节点的 Lodash 式工具库（译注：Lodash 是一个 JavaScript 函数工具库，提供了基于函数式编程风格的众多工具函数）， 它包含了构造、验证以及变换 AST 节点的方法。该工具库包含考虑周到的工具方法，对编写处理AST逻辑非常有用。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm install babel-types -D;
  
import traverse from &quot;babel-traverse&quot;;

import * as t from &quot;babel-types&quot;;

traverse(ast,{
    enter(path){   
        if(t.isIdentifier(path.node,{name:&quot;n&quot;})){
            path.node.name =&quot;x&quot;;
        }
    }
});
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>JS CODE -&gt; AST</p> <h3 id="visitors-访问者"><a href="#visitors-访问者" class="header-anchor">#</a> Visitors (访问者)</h3> <p>当我们谈及“进入”一个节点，实际上是说我们在访问它们， 之所以使用这样的术语是因为有一个访问者模式（visitor）的概念。</p> <p>访问者是一个用于 AST 遍历的跨语言的模式。简单的说它们就是一个对象，定义了用于在一个树状结构中获取具体节点的方法。这么说有些抽象所以让我们来看一个例子。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Called!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 你也可以先创建一个访问者对象，并在稍后给它添加方法。</span>

<span class="token keyword">let</span> visitor <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">MemberExpression</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
visitor<span class="token punctuation">.</span><span class="token function-variable function">FunctionDeclaration</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><blockquote><p>注意：Identifier() { ... } 是 Identifier: { enter() { ... } } 的简写形式</p></blockquote> <p>这是一个简单的访问者，把它用于遍历中时，每当在树中遇见一个 Identifier 的时候会调用 Identifier() 方法。</p> <h3 id="paths-路径"><a href="#paths-路径" class="header-anchor">#</a> Paths（路径）</h3> <p>AST 通常会有许多节点，那么节点直接如何相互关联呢？我们可以使用一个可操作和访问的巨大可变对象表示节点之间的关联关系，或者也可以用Paths（路径）来简化这件事情。</p> <p>Path 是表示两个节点之间连接的对象。</p> <p>在某种意义上，路径是一个节点在树中的位置以及关于该节点各种信息的响应式 Reactive 表示。当你调用一个修改树的方法后，路径信息也会被更新。Babel 帮你管理这一切，从而使得节点操作简单，尽可能做到无状态。</p> <h3 id="paths-in-visitors-存在于访问者中的路径"><a href="#paths-in-visitors-存在于访问者中的路径" class="header-anchor">#</a> Paths in Visitors（存在于访问者中的路径）</h3> <p>当你有一个 Identifier() 成员方法的访问者时，你实际上是在访问路径而非节点。通过这种方式，你操作的就是节点的响应式表示（译注：即路径）而非节点本身。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> MyVisitor <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">Identifier</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Visiting: &quot;</span> <span class="token operator">+</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="babel插件规则"><a href="#babel插件规则" class="header-anchor">#</a> Babel插件规则</h3> <p>Babel的插件模块需要我们暴露一个function,function内返回visitor对象。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">//函数参数接受整个Babel对象,这里将它进行解构获取babel-types模块,用来操作AST。</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span>
<span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>types<span class="token operator">:</span>t<span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span>  <span class="token punctuation">{</span>
        visitor<span class="token operator">:</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="撸一个babel插件"><a href="#撸一个babel插件" class="header-anchor">#</a> 撸一个Babel插件</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>做一个简单的ES6转ES3插件:

1.let,const 声明-&gt; var 声明
  
2. 箭头函数 -&gt; 普通函数
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="文件结构"><a href="#文件结构" class="header-anchor">#</a> 文件结构</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>|--index.js  程序入口

|--plugin.js 插件实现

|--before.js 转化前代码

|--after.js  转化后代码

|--package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>首先,我们先创建一个package.json。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm init
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>package.json</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
    <span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;babelplugin&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;version&quot;</span><span class="token operator">:</span><span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;description&quot;</span><span class="token operator">:</span><span class="token string">&quot;create babel plugin&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;main&quot;</span><span class="token operator">:</span><span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;babel&quot;</span><span class="token operator">:</span><span class="token string">&quot;node ./index.js&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webfansplz&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;license&quot;</span><span class="token operator">:</span><span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;devDependencies&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span>
        <span class="token string">&quot;@babel/core&quot;</span><span class="token operator">:</span><span class="token string">&quot;^7.2.2&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>可以看到,我们首先下载了@babel/core作为我们的开发依赖,然后配置了npm run babel作为开发命令。</p> <p><strong>index.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transform <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//读取需要转换的js字符串</span>

<span class="token keyword">const</span> before <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./before.js'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//使用babel-core的transform API 和插件进行字符串-&gt;AST转化。</span>

<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>before<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugin'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 存在after.js删除</span>
fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">'./after.js'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">'./after.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 写入转化后的结果到after.js</span>
fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'./after.js'</span><span class="token punctuation">,</span>res<span class="token punctuation">.</span>code<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>我们首先来实现 功能 1. let,const 声明 -&gt; var 声明</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>let code = 1;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们通过传送门查看到上面代码对应的AST结构为</p> <p><img src="/img/646.png" alt="646.png" title="646.png"></p> <p>我们可以看到这句声明语句位于VariableDeclaration节点,我们接下来只要操作VariableDeclaration节点对应的kind属性就可以啦~</p> <p><strong>before.js</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>const a = 123;

let b = 456;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>plugin.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span>
        <span class="token comment">//访问者</span>
        visitor<span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token comment">//我们需要操作的访问者方法(节点)</span>
            <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//该路径对应的节点</span>
                <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
                <span class="token comment">//判断节点kind属性是let或者const,转化为var</span>
                <span class="token punctuation">[</span><span class="token string">'let'</span><span class="token punctuation">,</span> <span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind <span class="token operator">=</span> <span class="token string">'var'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>ok~ 我们来看看效果!</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm run babel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>after.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">123</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">456</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>功能1搞定,接下来实现功能2. 箭头函数 -&gt; 普通函数 (this指向暂不做处理~)</p> <p>我们先来看看箭头函数对应的节点是什么?</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span>y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token operator">+</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>上面代码对应的AST结构为:</p> <p><img src="/img/647.jpg" alt="647.jpg" title="647.jpg"></p> <p>我们可以看到普通函数对应的节点是FunctionExpression。</p> <p>所以我们的实现思路只要进行节点替换(ArrowFunctionExpression-&gt;FunctionExpression)就可以啦。</p> <p><strong>plugin.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> types<span class="token operator">:</span> t <span class="token punctuation">}</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">{</span>
        <span class="token comment">//访问者</span>
        visitor<span class="token operator">:</span><span class="token punctuation">{</span>
            <span class="token comment">//我们需要操作的访问者方法(节点)</span>
            <span class="token function">VariableDeclaration</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//该路径对应的节点</span>
                <span class="token keyword">const</span> node <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
                <span class="token comment">//判断节点kind属性是let或者const,转化为var</span>
                <span class="token punctuation">[</span><span class="token string">'let'</span><span class="token punctuation">,</span> <span class="token string">'const'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>kind <span class="token operator">=</span> <span class="token string">'var'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">//箭头函数对应的访问者方法(节点)</span>
            <span class="token function">ArrowFunctionExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment">//该路径对应的节点信息</span>
                <span class="token keyword">let</span> <span class="token punctuation">{</span> id<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> generator<span class="token punctuation">,</span> async <span class="token punctuation">}</span> <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
                <span class="token comment">//进行节点替换 (arrowFunctionExpression-&gt;functionExpression)</span>
                path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">functionExpression</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> generator<span class="token punctuation">,</span>async<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code>npm run babel
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>after.js</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x<span class="token punctuation">,</span> y</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>以上已经完成了转换。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/17/2021, 9:45:40 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/home/miniprograms/rumen.html" class="prev">
        桥接原理
      </a></span> <span class="next"><a href="/home/others/clinux.html">
        前端常用Linux命令
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2e2609af.js" defer></script><script src="/assets/js/2.13f24521.js" defer></script><script src="/assets/js/61.808b2edd.js" defer></script>
  </body>
</html>
